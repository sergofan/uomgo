<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="x-posts">
	<template>
		<style is="custom-style" include="shared-styles">
			:host {
				display: block;
				word-wrap: break-word;
			}

			paper-card {
				--paper-card: {
					text-align: center;
					@apply(--layout-vertical);
			    margin: 16px 16px 0 16px;
			    padding: 20px;
			    border-radius: 8px;
			    background-color: white;
			    border: 1px solid #ddd;

				};
				--paper-card-header-text: {
					text-align: center;
				};
				--paper-card-content: {
					text-align: center;
				};
				--paper-card-actions: {
					text-align: center;
				};
			}

			.loadingIndicator {
	      text-align: center;
	      height: 40px;
	    }

			.loadingIndicator paper-spinner {
	      width: 20px;
	      height: 20px;
	      margin-right: 10px;
	    }

			iron-list {
				background-color: var(--paper-grey-200, #eee);
		    padding-bottom: 16px;
		  }

			iron-image {
				/*max-width: 100%;*/
				/*height: auto;*/
				/*--iron-image-width: 100%;*/
				/*--iron-image-height: auto;*/
			}
			iron-image::shadow img {
					max-width: 100%;
					/*height: auto;*/
			}
		</style>

		<firebase-query id="firebaseQueryPosts"
										path="/posts"
										app-name="uomgo"
										order-by-child="date"
										start-at="{{startAt}}"
										end-at="{{endAt}}"
										limit-to-first="[[limitToFirst]]"
										limit-to-last="[[limitToLast]]"
										order-by-child="date"
										data="{{dataDB}}"></firebase-query>

		<array-filter
				items="[[dataDB]]"
				filtered="{{filtered}}"
				sort="_computeSort"
				filter="_filter"></array-filter>

			<iron-list id="list"
								 items="[[filtered]]"
								 as="post"
								 scroll-target="html"
								 selection-enabled
								 multi-selection>
				<template id="templateList">
					<div>
						<paper-card tabindex$="[[tabIndex]]"
												elevation="4">
							<div class="heading paper-font-headline">
								[[post.name]]
							</div>
						  <div class="card-content layout vertical center-center">
								<div id="imageBox">
									<template  is="dom-if"
														 if="[[post.image]]"
														 on-dom-change="_onDomIfChange">
										<iron-image class="postImage"
																src="[[post.image]]"
																contain	preload
																on-loaded-changed="_onLoadedChanged"
																align="center"></iron-image>
									</template>
								</div>
								<div>
									<template is="juicy-html"
														content$="[[post.text]]"></template>
								</div>
							</div>
						</paper-card>
					</div>
				</template>
			</iron-list>

	</template>
	<script>
	(function() {
		'use strict';

			Polymer({
				is: 'x-posts',
				behaviors: [
					Polymer.NeonAnimationRunnerBehavior
				],
				properties: {
					animationConfig: {
						value: function() {
							return {
								'entry': [{
									name: 'cascaded-animation',
									animation: 'scale-up-animation',
									node: this,
									nodeDelay: 50,
									timing: {
										duration: 150,
										delay: 0
									}
								}]
							};
						}
					},
					user: {
						type: Object
					},
					limitToLast: {
						type: Number,
						notify: true
					},
					limitToFirst: {
						type: Number,
						notify: true,
					},
					startAt: {
						type: String,
						notify: true
					},
					endAt: {
						type: String,
						notify: true,
					}
				},

				ready: function() {
				},

				_computeSort: function(a, b) {
					if (a.date == b.date) {
						return 0;
					}
					return a.date > b.date ? -1 : 1;
				},

				_filter: function(item) {
					var todayDate = new Date();
					var todayMM = todayDate.getMonth()+1; //January is 0!
					var todayYYYY = todayDate.getFullYear();
					var itemDate = new Date(item.date);
					var itemMM = itemDate.getMonth()+1;
					var itemYYYY = itemDate.getFullYear();

					if ( itemYYYY === todayYYYY && itemMM > 8  ) {
						return true;
					};
				},

				_renderRepeat: function () {
					var xPostItems = Polymer.dom(this.root).querySelectorAll('x-post-item');
					this.animationConfig['entry'][0].nodes = Array.prototype.slice.call(xPostItems);
					this.playAnimation('entry');
				},

				_loadMoreData: function () {
					// load async stuff. e.g. XHR
			    asyncStuff(function done() {
			      ironScrollTheshold.clearTriggers();
			    });
				},

				_onDomIfChange: function(e) {
					// var item = this.$.list.modelForElement(e.currentTarget.parentElement).post;
	        // this.$.list.updateSizeForItem(item);
					// console.log( item );
					// this.$.list.fire('iron-resize');
		    },

				_onLoadedChanged: function(e) {
					if (e.currentTarget.offsetParent) {
						var item = this.$.list.modelForElement(e.currentTarget.offsetParent).post;
						// this.$.list.updateSizeForItem(item);
						// this.$.list.fire('iron-resize');
						this.$.list.notifyResize();
					};
				}

			});
	})();
	</script>
</dom-module>
