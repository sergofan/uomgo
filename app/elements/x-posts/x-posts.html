<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="../../scripts/scorocode.min.js"></script>

<dom-module id="x-posts">
	<template>
		<style is="custom-style" include="shared-styles">
			:host {
				display: block;
				word-wrap: break-word;
			}

			paper-card {
				transition: all 250ms ease-out;
				--paper-card: {
					@apply(--layout-vertical);
					background-color: white;
					border: 1px solid #ddd;
					border-radius: 8px;
					/*margin: 16px 16px 0 16px;*/
					/*margin: 0 16px 16px;*/
					margin-bottom: 16px;
					padding: 16px;
					text-align: center;
				};
				--paper-card-header-text: {
					text-align: center;
				};
				--paper-card-content: {
					text-align: center;
				};
				--paper-card-actions: {
					text-align: center;
					padding: 16px 16px 0;
				};
			}

			paper-icon-button.edit {
				/*--paper-icon-button-ink-color: white;*/
				--paper-icon-button: {
					width: 24px;
					height: 24px;
					background-color: white;
					color: var(--paper-green-a700);
					border-radius: 3px;
					padding: 0px;
				}
				--paper-icon-button-hover: {
					background-color: var(--paper-green-a400);
					color: black;
				}
			}

			paper-icon-button.delete {
				/*--paper-icon-button-ink-color: black;*/
				--paper-icon-button: {
					width: 24px;
					height: 24px;
					background-color: white;
					color: var(--paper-red-500);
					border-radius: 3px;
					padding: 0px;
				}
				--paper-icon-button-hover: {
					background-color: var(--paper-red-500);
					color: white;
				}
			}

			paper-card:hover {
				cursor: pointer;
				transform: scale(1.02);
			}

			.loadingIndicator {
				height: 40px;
	      text-align: center;
	    }

			.loadingIndicator paper-spinner {
				height: 20px;
				margin-right: 10px;
	      width: 20px;
	    }

			iron-list {
				background-color: var(--paper-grey-200, #eee);
		    padding-bottom: 16px;
				margin: 0 16px;
		  }

			@media (max-width: 600px) {
				iron-list {
					margin-left: 0;
					margin-right: 0;
				}
			}

			iron-image {
				/*--iron-image-width: 100%;*/
				--iron-image-height: 100%;
				/*max-width: 320px;*/
				display: block;
				height: 240px;
				padding-right: 16px;
			}

			.text-box {
				align-content: center;
				/*max-height: calc(360px - 32px);*/
				min-width: 207px;
				padding: 0;
				overflow: auto;
				height: 240px;
			}

		</style>

		<!-- <firebase-query id="firebaseQueryPosts"
										path="/posts"
										app-name="uomgo"
										data="{{dataDB}}"
										order-by-child="date"></firebase-query> -->

		<!-- <firebase-query id="firebaseQueryPosts"
										path="/posts"
										app-name="uomgo"
										data="{{dataDB}}"
										order-by-child="date"></firebase-query> -->

		<!-- <iron-ajax
		    auto
		    url="https://api.scorocode.ru/api/v1/data/find"
				content-type="application/json"
		    params='{ "app" : "671087465f924714b2f7e212f5d68f55",
									"cli" : "9c386463a16541ffbf0740adb7c35cf8",
    							"acc" : "18a2419c9b6e4d6e8870836dd7d7e23c",
							    "coll" : "posts"}'
		    handle-as="json"
		    on-response="_handleResponse"
		    debounce-duration="300"></iron-ajax> -->

		<array-filter
				items="{{dataDB}}"
				filtered="{{_posts}}"
				filter="_filter"
				observe="enabled-date"></array-filter>


		<iron-scroll-threshold id="scrollTheshold"
												   lower-threshold="500"
												   on-lower-threshold="_loadMoreData">
			<iron-list id="ironList"
								 items="[[_posts]]"
								 as="post"
								 scroll-target="scrollThreshold"
								 selection-enabled>

				<template id="templateList">
					<div>
						<template is="dom-if" if="[[post.enabled]]" on-dom-change="_onDomIfChange">
							<paper-card tabindex$="[[tabIndex]]"
													elevation="4"
													on-tap="_showDialog">
								<div class="heading paper-font-headline">
									[[post.name]]
								</div>
							  <div class="card-content layout horizontal center-center wrap">
									<div class="imageBox">

										<template is="dom-if"
															if="[[post.image]]">
											<iron-image class="postImage"
																	src="[[post.image]]"
																	contain	preload
																	position="center"
																	on-loaded-changed="_onLoadedImage"
																	align="center"></iron-image>
										</template>

										<template is="dom-if"
															if="[[post.video-id]]">
											<iron-image class="video-id"
																	src="https://i3.ytimg.com/vi/[[post.video-id]]/hqdefault.jpg"
																	contain	preload
																	position="center"
																	on-loaded-changed="_onLoadedImage"
																	align="center"></iron-image>
										</template>

									</div>

									<template is="dom-if"
														if="[[post.text]]">
										<div class="text-box flex layout vertical shadow">
											<div class="content" style="margin: auto 0;">
												<template is="juicy-html"
												content$="[[post.text]]"></template>
											</div>
										</div>
									</template>

								</div>
								<div class="card-actions layout horizontal center-justified wrap">
									<div class="layout vertical center-center flex">
										<moment-js date="[[post.date]]" format="DD.MM.YYYYг."></moment-js>
									</div>
									<div hidden$="[[!user]]">
										<paper-icon-button class="edit"
																			 icon="image:edit"></paper-icon-button>
										<paper-icon-button class="delete"
																			 icon="delete"></paper-icon-button>
									</div>
								</div>
							</paper-card>
						</template>
					</div>

				</template>
			</iron-list>
		</iron-scroll-threshold>

		<x-post-dialog-item on-tap="_showDialog"
												data-item=[[dataItem]]
												opened="{{opened}}"></x-post-dialog-item>

	  <div class="loadingIndicator">
			<paper-spinner-lite active
										 alt="Загрузка ..."></paper-spinner-lite>
	  </div>


	</template>
	<script>
	(function() {
		'use strict';

			Polymer({
				is: 'x-posts',
				behaviors: [
					Polymer.NeonAnimationRunnerBehavior
				],
				properties: {
					dataDB: {
			      type: Object,
			      observer: '_dataChanged'
			    },
					animationConfig: {
						value: function() {
							return {
								'entry': [{
									name: 'cascaded-animation',
									animation: 'scale-up-animation',
									node: this,
									nodeDelay: 50,
									timing: {
										duration: 150,
										delay: 0
									}
								}]
							};
						}
					},
					numberOfRecords: {
						type: Number,
						value: 10
					},
					youtubeStyle: {
						type: String
					},
					user: {
						type: Object
					},
					dataItem: {
						type: Object,
						value: {}
					},
					opened: {
						type: Boolean,
						value: false
					},
					n: {
						type: Number,
						value: 0
					},
					sc: {
						type: Object,
						value: {}
					}
				},

				ready: function() {
					var ironList = this.querySelector('#ironList');
					var scrollTheshold = this.querySelector('#scrollTheshold');
					var headerPanelMain = document.querySelector('#headerPanelMain');
				  scrollTheshold.scrollTarget = headerPanelMain.scroller;

					this.youtubeStyle = "display: inherit !important;";
					this.youtubeStyle += " background: url(";
					this.youtubeStyle += app.baseUrl;
					this.youtubeStyle += "images/youtube.png)";
					this.youtubeStyle += " 50% 50% / cover no-repeat transparent;";
					this.youtubeStyle += " background-size: cover;";

					this._scInit();
				},

				_dataChanged: function (newData, oldData) {
					this.n += 1;
					console.log(this.n, newData, oldData);
			  },

				_computeSort: function(a, b) {
					if (a.date == b.date) {
						return 0;
					}
					return a.date > b.date ? -1 : 1;
				},

				// _filter: function(item) {
				// 	var todayDate = new Date();
				// 	var todayMM = todayDate.getMonth()+1; //January is 0!
				// 	var todayYYYY = todayDate.getFullYear();
				// 	var itemDate = new Date(item.date);
				// 	var itemMM = itemDate.getMonth()+1;
				// 	var itemYYYY = itemDate.getFullYear();
				// 	// if ( todayYYYY - itemYYYY === 1 && itemMM > 8 ) {
				// 	// 	return true;
				// 	// } else if ( todayYYYY - itemYYYY === 0 && itemMM < 6 ) {
				// 	// 	return true;
				// 	// } else return false;
				//
				// 	if ( itemYYYY === 2016 && itemMM === 10 ) {
				// 		return true;
				// 	} else return false;
				// },

				_filter: function(item, index) {
					// var todayDate = new Date();
					// var todayMM = todayDate.getMonth()+1; //January is 0!
					// var todayYYYY = todayDate.getFullYear();
					// var itemDate = new Date(item.date);
					// var itemMM = itemDate.getMonth()+1;
					// var itemYYYY = itemDate.getFullYear();
					//
					// if ( itemYYYY === 2016 ) {
					// 	if ( itemMM === 11 ) {
					// 		// console.log( typeof(itemDate) );
					// 		return true;
					// 	}
					// } else {
					// 	return false;
					// }

					// if (index < this.numberOfRecords) {
						return true;
					// }
				},

				_renderRepeat: function () {
					var xPostItems = Polymer.dom(this.root).querySelectorAll('x-post-item');
					this.animationConfig['entry'][0].nodes = Array.prototype.slice.call(xPostItems);
					this.playAnimation('entry');
				},

				_onDomIfChange: function(e) {
					// var post = this.$.ironList.modelForElement(e.currentTarget.parentElement).post;
	        // this.$.ironList.updateSizeForItem(post);
					// this.$.ironList.notifyResize();
				},

				_loadMoreData: function (e) {
					// console.log("_loadMoreData", e.target);
					// this.numberOfRecords += 1;
					e.target.clearTriggers();
				},

				_onLoadedImage: function(e) {
					if ( e.target.offsetParent ) {
						if ( e.target.classList.contains("video-id") ) {
							e.target.$$("#placeholder").style.cssText = this.youtubeStyle;
						};
						if ( e.target.offsetParent.querySelector('.juicy-box') ) {
							// e.target.offsetParent.querySelector('.juicy-box').style.height = e.target.offsetHeight+'px';
						};
						// this.$.ironList.notifyResize();
					};
				},

				_showDialog: function(e) {
					if (e.model) {
						this.dataItem = e.model.post;
						this.opened = true;
					};
				},

				_handleResponse: function(data) {
					console.log( data.detail.response );
				},

				_scInit: function() {
					var sc = require('scorocode');
					sc.Init({
					    ApplicationID: "671087465f924714b2f7e212f5d68f55",
					    JavaScriptKey: "9c386463a16541ffbf0740adb7c35cf8",
							MasterKey: "18a2419c9b6e4d6e8870836dd7d7e23c"
					});
					// Создадим новый экземпляр запроса к коллекции items.
					sc.Query("items");
					// Запросим все объекты коллекции
					data.find()
					    // Обработка успешного выполнения запроса
					    .then((finded) =>{
					        var util = require('util');
					        //Выведем полученные данные в консоль
					        console.log(util.inspect(finded, {showHidden: false, depth: null}))
					    })
					    // Обработка ошибки
					    .catch((err)=>{
					        console.log(err)
					    });
				}

			});
	})();
	</script>
</dom-module>
